---
paths:
  - "backend/app/**/*.py"
  - "backend/.env*"
---

# Python セキュリティルール

認証不要・シングルユーザー・クローズ環境前提。ただし基本的な対策は実装する。

## API キー管理

- `ANTHROPIC_API_KEY` は環境変数 (`backend/.env`) で管理。ハードコードしない
- `.env` は `.gitignore` に含める
- エラーレスポンスにAPIキーやスタックトレースを含めない

## ファイルアップロード

- MIME タイプをホワイトリスト制限 (`image/jpeg`, `image/png`, `image/webp`)
- ファイルサイズ上限 10MB
- ファイル名はサーバー側で UUID に置換
- 保存先は `uploads/` に限定。パストラバーサル防止に `pathlib.Path` を使用

## データベース

- SQLAlchemy ORM を使用。生SQL文字列を組み立てない
- ユーザー入力値を直接クエリに埋め込まない

## CORS

- `CORS_ORIGINS` は環境変数で制御。開発時デフォルトは `http://localhost:5173`

## 機密情報

- ログに画像データやレシート詳細を出力しない
- エラー時は内部情報を隠蔽し汎用メッセージを返す

## 依存パッケージ

- 既知の脆弱性があるパッケージを放置しない
- パッケージ追加時はメンテナンス状況と脆弱性情報を確認する

---

## 補足: 公開環境で運用する場合に追加すべき対策

> 現在はクローズ環境前提のため以下は適用外。外部公開する際に対応すること。

- 認証・認可: 全APIに認証導入 (JWT/セッション)、オーナー認可チェック、トークンローテーション
- 通信の暗号化: HTTPS必須、`Strict-Transport-Security` ヘッダー
- レート制限: APIエンドポイント (特に画像アップロード・Vision API) にレート制限導入
- アップロード強化: マジックバイト検証、マルウェアスキャン検討
- セキュリティヘッダー: CSP, `X-Content-Type-Options: nosniff`, `X-Frame-Options: DENY`
- データ保護: PostgreSQL移行、DB暗号化・バックアップ、保持期間ポリシー、監査ログ
- インフラ: WAF導入、コンテナ化、定期的な脆弱性診断
