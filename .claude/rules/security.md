# セキュリティルール

## 前提

- 認証不要・シングルユーザー・クローズ環境前提のアプリである
- ただし基本的なセキュリティ対策は実装する

## API キー管理

- `ANTHROPIC_API_KEY` は環境変数 (`backend/.env`) で管理する
- APIキーをソースコードにハードコードしない
- `.env` ファイルは `.gitignore` に含め、リポジトリにコミットしない
- エラーレスポンスにAPIキーやスタックトレースを含めない

## ファイルアップロード

- 許可する MIME タイプを厳格にホワイトリスト制限する (`image/jpeg`, `image/png`, `image/webp`)
- ファイルサイズの上限を設ける (現在 10MB)
- アップロードファイル名はサーバー側で UUID に置換する。クライアントから送られたファイル名をそのまま使わない
- ファイル保存先は専用ディレクトリ (`uploads/`) に限定する
- パストラバーサル攻撃を防ぐため、ファイルパスの組み立てには `pathlib.Path` を使用する

## データベース

- SQL インジェクション防止のため、SQLAlchemy ORM を使用する。生SQL文字列を組み立てない
- ユーザー入力値を直接クエリに埋め込まない (ORM のパラメータバインディングを使う)

## フロントエンド

- ユーザー入力やAPIレスポンスを `dangerouslySetInnerHTML` で描画しない
- API 呼び出しは `api/client.ts` の Axios インスタンス経由で行い、baseURL を一元管理する

## CORS

- `CORS_ORIGINS` は環境変数で制御する。本番環境では必要最小限のオリジンのみ許可する
- 開発時のデフォルトは `http://localhost:5173` のみ

## 依存パッケージ

- 既知の脆弱性があるパッケージを放置しない
- パッケージ追加時はメンテナンス状況と脆弱性情報を確認する

## 機密情報の取り扱い

- レシート画像には個人情報・取引情報が含まれる可能性がある
- ログに画像データやレシートの詳細内容を出力しない
- エラーハンドリングでは内部情報を隠蔽し、クライアントには汎用的なメッセージを返す

---

## 補足: 公開環境で運用する場合に追加すべき対策

> 現在はクローズ環境前提のため以下は適用外。外部公開する際に対応すること。

### 認証・認可

- すべてのAPIエンドポイントに認証を導入する (JWT / セッション等)
- レシートデータへのアクセスはオーナーのみに制限する (認可チェック)
- APIキーやトークンの有効期限・ローテーションを設定する

### 通信の暗号化

- HTTPS を必須にする (TLS 証明書の導入)
- フロントエンドの baseURL を `https://` に変更する
- `Strict-Transport-Security` ヘッダーを設定する

### レート制限

- APIエンドポイントにレート制限を導入する (特に画像アップロード・Vision API 呼び出し)
- 短時間の大量リクエストをブロックする

### アップロードの強化

- MIME タイプだけでなく、ファイルのマジックバイト (先頭バイト列) で実際の画像形式を検証する
- ウイルス・マルウェアスキャンの導入を検討する

### セキュリティヘッダー

- `Content-Security-Policy` でスクリプトやリソースの読み込み元を制限する
- `X-Content-Type-Options: nosniff` を設定する
- `X-Frame-Options: DENY` でクリックジャッキングを防止する
- アップロード画像の配信に `Content-Disposition: attachment` を設定する

### データ保護

- SQLite から PostgreSQL 等の本番用DBに移行する
- DB の暗号化・バックアップ・アクセス制御を設定する
- レシートデータの保持期間ポリシーを定める
- 監査ログ (操作履歴) を記録する

### インフラ

- WAF (Web Application Firewall) の導入を検討する
- コンテナ化してネットワークを分離する
- 定期的な脆弱性診断を実施する
